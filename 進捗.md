# SNS プラットフォーム開発まとめ

## プロジェクト概要

TypeScript + Next.js + Express + PostgreSQL + Docker で構築する SNS プラットフォームの開発プロジェクトです。

### 技術スタック

- **フロントエンド**: Next.js 14 + TypeScript + Tailwind CSS
- **バックエンド**: Express + TypeScript + Prisma ORM
- **データベース**: PostgreSQL 15
- **コンテナ**: Docker + Docker Compose
- **開発環境**: Linux (Ubuntu)

---

## 現在の進捗状況

### ✅ 完了済み項目

#### 1. プロジェクト構造セットアップ

```
sns-platform/
├── docker-compose.yml
├── frontend/                   # Next.jsアプリケーション
│   ├── src/app/
│   ├── package.json
│   └── next.config.js
├── backend/                    # Express APIサーバー
│   ├── src/
│   │   ├── lib/
│   │   │   └── prisma.ts      ✅ 完成
│   │   ├── controllers/       ✅ userController.ts 実装済み
│   │   ├── routes/            # 作成済み（空）
│   │   ├── types/             # 作成済み（空）
│   │   └── server.ts          ✅ 完成
│   ├── prisma/
│   │   ├── schema.prisma      ✅ 完成
│   │   ├── migrations/        ✅ 完成
│   │   └── seed.js           ✅ 完成
│   └── package.json
```

#### 2. Docker 環境

- PostgreSQL コンテナ起動済み
- データベース `snsplatform` 作成済み
- ユーザー: `snsuser` / パスワード: `snspassword`

#### 3. データベース設計（Prisma スキーマ）

- User, Post, Follow, Like, Comment, PostImage テーブル設計完了
- マイグレーション実行済み
- サンプルデータ投入済み（Alice, Bob のユーザー + 投稿 + フォロー + いいね）

#### 4. バックエンド基盤

- Express サーバー設定完了
- Prisma クライアント設定完了
- TypeScript 設定完了
- **userController.ts 実装完了**

---

## User API 仕様

### 基本情報

- Base URL: `http://localhost:8000/api`
- Content-Type: `application/json`
- 認証: 未実装（後で JWT 実装予定）

### 実装済みエンドポイント

#### 1. ユーザー作成

```http
POST /api/users
```

**Request Body:**

```json
{
  "email": "user@example.com",
  "username": "johndoe",
  "displayName": "John Doe",
  "bio": "Hello, I'm John!" // optional
}
```

**Response (201 Created):**

```json
{
  "success": true,
  "data": {
    "id": "clxxx123456789",
    "email": "user@example.com",
    "username": "johndoe",
    "displayName": "John Doe",
    "bio": "Hello, I'm John!",
    "profileImageUrl": null,
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  },
  "message": "User created successfully"
}
```

#### 2. ユーザー情報取得

```http
GET /api/users/:id
```

**Response (200 OK):**

```json
{
  "success": true,
  "data": {
    "id": "clxxx123456789",
    "email": "user@example.com",
    "username": "johndoe",
    "displayName": "John Doe",
    "bio": "Hello, I'm John!",
    "profileImageUrl": null,
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z",
    "_count": {
      "posts": 5,
      "followers": 10,
      "following": 8
    }
  }
}
```

#### 3. ユーザー一覧取得（ページネーション付き）

```http
GET /api/users?page=1&limit=10
```

**Response (200 OK):**

```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": "clxxx123456789",
        "username": "johndoe",
        "displayName": "John Doe",
        "bio": "Hello, I'm John!",
        "profileImageUrl": null,
        "createdAt": "2024-01-15T10:30:00.000Z",
        "_count": {
          "posts": 5,
          "followers": 10
        }
      }
    ],
    "pagination": {
      "currentPage": 1,
      "totalPages": 5,
      "totalItems": 50,
      "hasNext": true,
      "hasPrev": false
    }
  }
}
```

#### 4. ユーザー情報更新

```http
PUT /api/users/:id
```

**Request Body:**

```json
{
  "displayName": "John Smith", // optional
  "bio": "Updated bio", // optional
  "profileImageUrl": "https://example.com/image.jpg" // optional
}
```

#### 5. ユーザー削除

```http
DELETE /api/users/:id
```

**Response (200 OK):**

```json
{
  "success": true,
  "message": "User deleted successfully"
}
```

### 今後実装予定の API

#### SNS 機能

- `GET /api/users/search?q=john` - ユーザー検索
- `GET /api/users/:id/followers` - フォロワー一覧
- `GET /api/users/:id/following` - フォロー中一覧
- `GET /api/users/:id/posts` - ユーザーの投稿一覧
- `GET /api/users/:id/likes` - いいねした投稿一覧

---

## 現在のコード実装状況

### userController.ts の特徴

#### エラーハンドリング

- Prisma の重複エラー（P2002）を適切にキャッチ
- ユーザーが見つからない場合（P2025）のハンドリング
- TypeScript の`unknown`型を使用した安全なエラー処理

#### セキュリティ対策

- `Math.min`を使用した DoS 攻撃防止（limit 上限 50 件）
- `select`を使用した機密情報（email）の除外

#### パフォーマンス最適化

- `Promise.all`を使用した並列処理
- 必要なフィールドのみを取得する`select`クエリ
- 効率的なページネーション実装

#### 実装例（getAllUsers）

```typescript
export const getAllUsers = async (req: Request, res: Response) => {
  try {
    // クエリパラメータの安全な処理
    const page = parseInt(req.query.page as string) || 1;
    const limit = Math.min(parseInt(req.query.limit as string) || 10, 50);
    const skip = (page - 1) * limit;

    // 並列処理でパフォーマンス向上
    const [users, totalCount] = await Promise.all([
      prisma.user.findMany({
        select: {
          // 必要なフィールドのみ取得（emailは除外）
          id: true,
          username: true,
          displayName: true,
          bio: true,
          profileImageUrl: true,
          createdAt: true,
          _count: {
            select: {
              posts: true,
              followers: true,
            },
          },
        },
        skip,
        take: limit,
        orderBy: { createdAt: "desc" },
      }),
      prisma.user.count(),
    ]);

    const totalPages = Math.ceil(totalCount / limit);

    res.status(200).json({
      success: true,
      data: {
        users,
        pagination: {
          currentPage: page,
          totalPages,
          totalItems: totalCount,
          hasNext: page < totalPages,
          hasPrev: page > 1,
        },
      },
    });
  } catch (error) {
    console.error("Get users error:", error);
    res.status(500).json({ error: "Failed to fetch users" });
  }
};
```

---

## データベース構造

### 主要テーブル

#### User テーブル

```sql
- id (String, PK, CUID)
- email (String, Unique)
- username (String, Unique)
- displayName (String)
- bio (Text, Optional)
- profileImageUrl (String, Optional)
- createdAt (DateTime)
- updatedAt (DateTime)
```

#### Post テーブル

```sql
- id (String, PK, CUID)
- userId (String, FK -> User.id)
- content (String, 280文字制限)
- createdAt (DateTime)
- updatedAt (DateTime)
- deletedAt (DateTime, Optional)
```

#### Follow テーブル

```sql
- id (String, PK, CUID)
- followerId (String, FK -> User.id)
- followingId (String, FK -> User.id)
- createdAt (DateTime)
- UNIQUE(followerId, followingId)
```

#### Like テーブル

```sql
- id (String, PK, CUID)
- userId (String, FK -> User.id)
- postId (String, FK -> Post.id)
- createdAt (DateTime)
- UNIQUE(userId, postId)
```

---

## 次の実装予定

### 🔄 現在の優先タスク

1. **型定義ファイルの作成**

   - `backend/src/types/user.ts`
   - `CreateUserRequest`, `UpdateUserRequest` インターフェース定義

2. **ルート定義の実装**

   - `backend/src/routes/users.ts`
   - userController の各関数をエンドポイントに接続

3. **サーバーへのルート接続**

   - `backend/src/server.ts`の更新
   - `/api/users`ルートの追加

4. **API 動作確認**
   - Postman や curl での各エンドポイントテスト

### 🚀 今後の実装予定

#### Phase 1: 基本 API 実装

- [ ] Post Controller (投稿 CRUD)
- [ ] Follow Controller (フォロー機能)
- [ ] Like Controller (いいね機能)
- [ ] Comment Controller (コメント機能)

#### Phase 2: 認証機能

- [ ] JWT 認証の実装
- [ ] ユーザー登録・ログイン機能
- [ ] ミドルウェア認証

#### Phase 3: フロントエンド実装

- [ ] Next.js + TailwindCSS での UI 実装
- [ ] API 連携
- [ ] リアルタイム機能（WebSocket）

---

## 開発環境

### 起動方法

```bash
# 1. Docker環境起動
cd sns-platform
docker-compose up -d

# 2. バックエンド開発サーバー起動
cd backend
npm run dev

# 3. フロントエンド開発サーバー起動
cd frontend
npm run dev
```

### 動作確認 URL

- Backend: http://localhost:8000/health
- Frontend: http://localhost:3000
- Prisma Studio: `npx prisma studio` → http://localhost:5555

### よく使うコマンド

```bash
# データベース関連
npx prisma studio             # データベースブラウザ
npx prisma generate           # クライアント再生成
npx prisma migrate dev        # マイグレーション

# API動作確認
curl http://localhost:8000/health
curl http://localhost:8000/api/test

# Docker操作
docker-compose logs -f db     # DBログ確認
docker-compose down           # 環境停止
```

---

## 学習ポイント・ベストプラクティス

### セキュリティ

- DoS 攻撃防止のための limit 上限設定
- 機密情報（email 等）のレスポンス除外
- Prisma エラーの適切なハンドリング

### パフォーマンス

- `Promise.all`による並列処理
- `select`による必要フィールドのみの取得
- 効率的なページネーション実装

### TypeScript

- `unknown`型によるエラーハンドリング
- 適切な型定義の使用
- ES Module の正しい使用

### データベース設計

- 外部キーの正しい設計
- 一意制約による重複防止
- ソフトデリート（deletedAt）の実装

---

## 今後の課題・改善点

1. **バリデーション強化**: Zod 等を使用した入力値検証
2. **ログ管理**: Winston 等を使用した構造化ログ
3. **テスト実装**: Jest 等を使用した単体・統合テスト
4. **監視・メトリクス**: ヘルスチェックの充実
5. **セキュリティ強化**: レート制限、CORS 設定の最適化

---

この実装により、SNS プラットフォームの基盤となる User 管理機能が完成しました。次のステップとして、型定義とルート実装を進めていく予定です。
