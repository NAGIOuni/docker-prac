# SNS プラットフォーム開発まとめ

## プロジェクト概要

TypeScript + Next.js + Express + PostgreSQL + Docker で構築する SNS プラットフォームの開発プロジェクトです。

### 技術スタック

- **フロントエンド**: Next.js 14 + TypeScript + Tailwind CSS
- **バックエンド**: Express + TypeScript + Prisma ORM
- **データベース**: PostgreSQL 15
- **コンテナ**: Docker + Docker Compose
- **開発環境**: Linux (Ubuntu)

---

## 現在の進捗状況

### ✅ 完了済み項目

#### 1. プロジェクト構造セットアップ

```
sns-platform/
├── docker-compose.yml
├── frontend/                   # Next.jsアプリケーション
│   ├── src/app/
│   ├── package.json
│   └── next.config.js
├── backend/                    # Express APIサーバー
│   ├── src/
│   │   ├── lib/
│   │   │   └── prisma.ts      ✅ 完成
│   │   ├── controllers/       ✅ userController.ts 完全実装済み
│   │   ├── routes/            # 作成済み（空）
│   │   ├── types/             ✅ user.ts 完全実装済み
│   │   └── server.ts          ✅ 完成
│   ├── prisma/
│   │   ├── schema.prisma      ✅ 完成
│   │   ├── migrations/        ✅ 完成
│   │   └── seed.js           ✅ 完成
│   └── package.json
```

#### 2. Docker 環境

- PostgreSQL コンテナ起動済み
- データベース `snsplatform` 作成済み
- ユーザー: `snsuser` / パスワード: `snspassword`

#### 3. データベース設計（Prisma スキーマ）

- User, Post, Follow, Like, Comment, PostImage テーブル設計完了
- マイグレーション実行済み
- サンプルデータ投入済み（Alice, Bob のユーザー + 投稿 + フォロー + いいね）

#### 4. バックエンド基盤

- Express サーバー設定完了
- Prisma クライアント設定完了
- TypeScript 設定完了
- **userController.ts 完全実装済み ✨**
- **型定義システム完全実装済み ✨**

---

## 型定義システム 🎯

### 実装済み型定義（backend/src/types/user.ts）

#### Core Types

```typescript
// 基本ユーザー型（内部処理用）
export interface User {
  id: string;
  email: string;
  username: string;
  displayName: string;
  bio: string | null; // Prismaスキーマと一致
  profileImageUrl: string | null;
  createdAt: Date;
  updatedAt: Date;
}

// 公開用ユーザー型（email除外）
export interface PublicUser {
  id: string;
  username: string;
  displayName: string;
  bio: string | null;
  profileImageUrl: string | null;
  createdAt: Date;
  updatedAt: Date;
}

// 統計情報型
export interface UserCount {
  posts: number;
  followers: number;
  following?: number; // getAllUsersでは省略
}
```

#### Request/Response Types

```typescript
// リクエスト型
export interface CreateUserRequest {
  email: string;
  username: string;
  displayName: string;
  bio?: string | null;
  profileImageUrl?: string | null;
}

export interface UpdateUserRequest {
  displayName?: string;
  bio?: string | null;
  profileImageUrl?: string | null;
}

// レスポンス型
export interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
  message?: string;
}

export interface GetUsersResponse
  extends ApiResponse<PaginatedResponse<PublicUserWithCount>> {}
export interface GetUserResponse
  extends ApiResponse<User & { _count: UserCount }> {}
export interface CreateUserResponse extends ApiResponse<User> {
  message: string;
}
```

#### Type Guards

```typescript
export function isCreateUserRequest(obj: unknown): obj is CreateUserRequest;
export function isUpdateUserRequest(obj: unknown): obj is UpdateUserRequest;
```

---

## User API 仕様

### 基本情報

- Base URL: `http://localhost:8000/api`
- Content-Type: `application/json`
- 認証: 未実装（後で JWT 実装予定）

### 実装済みエンドポイント

#### 1. ユーザー作成

```http
POST /api/users
```

**特徴:**

- Type Guard による型安全なバリデーション
- Prisma エラー（P2002）の詳細処理
- 入力値のサニタイゼーション（trim）

**Request Body:**

```json
{
  "email": "user@example.com",
  "username": "johndoe",
  "displayName": "John Doe",
  "bio": "Hello, I'm John!" // optional
}
```

**Response (201 Created):**

```json
{
  "success": true,
  "data": {
    "id": "clxxx123456789",
    "email": "user@example.com",
    "username": "johndoe",
    "displayName": "John Doe",
    "bio": "Hello, I'm John!",
    "profileImageUrl": null,
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  },
  "message": "User created successfully"
}
```

#### 2. ユーザー情報取得

```http
GET /api/users/:id
```

**特徴:**

- 完全な型安全性（Request/Response 型パラメータ）
- null チェック後の型絞り込み
- 統計情報（following 含む）の取得

**Response (200 OK):**

```json
{
  "success": true,
  "data": {
    "id": "clxxx123456789",
    "email": "user@example.com",
    "username": "johndoe",
    "displayName": "John Doe",
    "bio": "Hello, I'm John!",
    "profileImageUrl": null,
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z",
    "_count": {
      "posts": 5,
      "followers": 10,
      "following": 8
    }
  }
}
```

#### 3. ユーザー一覧取得（ページネーション付き）

```http
GET /api/users?page=1&limit=10
```

**特徴:**

- 安全なクエリパラメータ処理（範囲チェック付き）
- 並列処理による効率的なデータ取得
- email フィールドの除外（セキュリティ）
- following 統計は省略（パフォーマンス最適化）

**Response (200 OK):**

```json
{
  "success": true,
  "data": {
    "data": [
      {
        "id": "clxxx123456789",
        "username": "johndoe",
        "displayName": "John Doe",
        "bio": "Hello, I'm John!",
        "profileImageUrl": null,
        "createdAt": "2024-01-15T10:30:00.000Z",
        "updatedAt": "2024-01-15T10:30:00.000Z",
        "_count": {
          "posts": 5,
          "followers": 10
        }
      }
    ],
    "pagination": {
      "currentPage": 1,
      "totalPages": 5,
      "totalItems": 50,
      "hasNext": true,
      "hasPrev": false
    }
  }
}
```

#### 4. ユーザー情報更新

```http
PUT /api/users/:id
```

**特徴:**

- 部分更新対応（undefined フィールドは更新しない）
- Type Guard による安全なバリデーション
- 空データチェック

**Request Body:**

```json
{
  "displayName": "John Smith", // optional
  "bio": "Updated bio", // optional
  "profileImageUrl": "https://example.com/image.jpg" // optional
}
```

#### 5. ユーザー削除

```http
DELETE /api/users/:id
```

**特徴:**

- Prisma エラー（P2025）の適切な処理
- 型安全なエラーレスポンス

**Response (200 OK):**

```json
{
  "success": true,
  "message": "User deleted successfully"
}
```

### 今後実装予定の API

#### SNS 機能

- `GET /api/users/search?q=john` - ユーザー検索
- `GET /api/users/:id/followers` - フォロワー一覧
- `GET /api/users/:id/following` - フォロー中一覧
- `GET /api/users/:id/posts` - ユーザーの投稿一覧
- `GET /api/users/:id/likes` - いいねした投稿一覧

---

## 実装の特徴・ベストプラクティス

### 🔒 型安全性

#### 完全な型システム

```typescript
// Request/Response の型パラメータ指定
export const createUser = async (
  req: Request<{}, CreateUserResponse, CreateUserRequest>,
  res: Response<CreateUserResponse>
): Promise<void> => {
```

#### Type Guards の活用

```typescript
// ランタイム型チェック
if (!isCreateUserRequest(req.body)) {
  const errorResponse: CreateUserResponse = {
    success: false,
    error: "Invalid request body format",
  };
  res.status(400).json(errorResponse);
  return;
}
```

#### null 許容性の適切な処理

```typescript
// Prismaスキーマとの一致
bio: string | null; // ✅ Prismaの String? と一致
profileImageUrl: string | null; // ✅ Prismaの String? と一致
```

### 🛡️ セキュリティ対策

#### DoS 攻撃防止

```typescript
// limit の上限設定
const limit = Math.min(
  Math.max(1, parseInt(req.query.limit || "10", 10) || 10),
  50
);
```

#### 機密情報保護

```typescript
// getAllUsers では email を除外
select: {
  id: true,
  username: true,
  displayName: true,
  bio: true,
  profileImageUrl: true,
  createdAt: true,
  updatedAt: true,
  // email: true,  ← 意図的に除外
```

#### 入力値サニタイゼーション

```typescript
// trim() による空白除去
email: email.trim(),
username: username.trim(),
displayName: displayName.trim(),
```

### ⚡ パフォーマンス最適化

#### 並列処理

```typescript
const [users, totalCount] = await Promise.all([
  prisma.user.findMany({...}),
  prisma.user.count(),
]);
```

#### 選択的取得

```typescript
// 必要なフィールドのみ取得
select: {
  id: true,
  username: true,
  // その他必要なフィールドのみ
},
```

#### 効率的なページネーション

```typescript
skip: (page - 1) * limit,
take: limit,
```

### 🚨 エラーハンドリング

#### Prisma エラーの詳細処理

```typescript
if (prismaError.code === "P2002") {
  const target = prismaError.meta?.target?.[0] || "field";
  const fieldName = target === "email" ? "Email" : "Username";

  const errorResponse: CreateUserResponse = {
    success: false,
    error: `${fieldName} already exists`,
  };
  res.status(409).json(errorResponse);
  return;
}
```

#### 型安全なエラーレスポンス

```typescript
const errorResponse: GetUserResponse = {
  success: false,
  error: "User not found",
};
res.status(404).json(errorResponse);
```

---

## 現在のコード実装状況

### userController.ts の実装内容

#### 1. getAllUsers

- **型安全性**: 完全な型パラメータ指定
- **セキュリティ**: email 除外、limit 上限設定
- **パフォーマンス**: 並列処理、選択的取得
- **機能**: ページネーション、ソート（createdAt desc）

#### 2. getUserById

- **型安全性**: null チェック後の型絞り込み
- **機能**: 統計情報取得（posts, followers, following）
- **エラー処理**: 404 レスポンス

#### 3. createUser

- **バリデーション**: Type Guard、必須フィールドチェック
- **セキュリティ**: 入力値サニタイゼーション
- **エラー処理**: Prisma 重複エラー詳細処理

#### 4. updateUser

- **機能**: 部分更新対応
- **バリデーション**: 空データチェック
- **型安全性**: Type Guard 活用

#### 5. deleteUser

- **エラー処理**: P2025 エラー適切な処理
- **型安全性**: 型安全なレスポンス構築

---

## データベース構造

### 主要テーブル

#### User テーブル

```sql
- id (String, PK, CUID)
- email (String, Unique)
- username (String, Unique)
- displayName (String)
- bio (String, Optional, null許容)
- profileImageUrl (String, Optional, null許容)
- createdAt (DateTime)
- updatedAt (DateTime)
```

#### Post テーブル

```sql
- id (String, PK, CUID)
- userId (String, FK -> User.id)
- content (String, 280文字制限)
- createdAt (DateTime)
- updatedAt (DateTime)
- deletedAt (DateTime, Optional)
```

#### Follow テーブル

```sql
- id (String, PK, CUID)
- followerId (String, FK -> User.id)
- followingId (String, FK -> User.id)
- createdAt (DateTime)
- UNIQUE(followerId, followingId)
```

#### Like テーブル

```sql
- id (String, PK, CUID)
- userId (String, FK -> User.id)
- postId (String, FK -> Post.id)
- createdAt (DateTime)
- UNIQUE(userId, postId)
```

---

## 次の実装予定

### 🔄 現在の最優先タスク

1. **ルート定義の実装**

   - `backend/src/routes/users.ts`
   - userController の各関数をエンドポイントに接続

2. **サーバーへのルート接続**

   - `backend/src/server.ts`の更新
   - `/api/users`ルートの追加

3. **API 動作確認**
   - Postman や curl での各エンドポイントテスト
   - 型安全性の実働確認

### 🚀 今後の実装予定

#### Phase 1: 基本 API 実装

- [ ] Post Controller (投稿 CRUD)
- [ ] Follow Controller (フォロー機能)
- [ ] Like Controller (いいね機能)
- [ ] Comment Controller (コメント機能)

#### Phase 2: 認証機能

- [ ] JWT 認証の実装
- [ ] ユーザー登録・ログイン機能
- [ ] ミドルウェア認証

#### Phase 3: フロントエンド実装

- [ ] Next.js + TailwindCSS での UI 実装
- [ ] API 連携
- [ ] リアルタイム機能（WebSocket）

---

## 開発環境

### 起動方法

```bash
# 1. Docker環境起動
cd sns-platform
docker-compose up -d

# 2. バックエンド開発サーバー起動
cd backend
npm run dev

# 3. フロントエンド開発サーバー起動
cd frontend
npm run dev
```

### 動作確認 URL

- Backend: http://localhost:8000/health
- Frontend: http://localhost:3000
- Prisma Studio: `npx prisma studio` → http://localhost:5555

### よく使うコマンド

```bash
# データベース関連
npx prisma studio             # データベースブラウザ
npx prisma generate           # クライアント再生成
npx prisma migrate dev        # マイグレーション

# API動作確認（実装後）
curl http://localhost:8000/health
curl http://localhost:8000/api/users

# Docker操作
docker-compose logs -f db     # DBログ確認
docker-compose down           # 環境停止
```

---

## 学習ポイント・実装のハイライト

### 🎯 TypeScript の活用

#### ジェネリクス型パラメータ

```typescript
Request<P, ResBody, ReqBody, ReqQuery>
        ↑    ↑       ↑       ↑
        |    |       |       └─ ?page=1&limit=10
        |    |       └───────── { "email": "..." }
        |    └─────────────── レスポンスボディの型
        └────────────────── /users/:id の :id 部分
```

#### Type Guards の実装

```typescript
export function isCreateUserRequest(obj: unknown): obj is CreateUserRequest {
  if (typeof obj !== "object" || obj === null) return false;

  const req = obj as Record<string, unknown>;
  return (
    typeof req.email === "string" &&
    typeof req.username === "string" &&
    typeof req.displayName === "string"
  );
}
```

#### Null 安全性

```typescript
// Early Return による型絞り込み
if (!user) {
  res.status(404).json(errorResponse);
  return; // ← 重要：これにより以降でuserはnon-null
}

// この時点で user は User型（nullではない）
const response: GetUserResponse = {
  success: true,
  data: user, // ✅ 型エラーなし
};
```

### 🔧 Prisma の活用

#### 選択的フィールド取得

```typescript
select: {
  id: true,
  username: true,
  displayName: true,
  // email を意図的に除外してセキュリティ向上
}
```

#### 関連データの取得

```typescript
include: {
  _count: {
    select: {
      posts: true,
      followers: true,
      following: true,
    },
  },
}
```

### 🚀 パフォーマンス最適化

#### 並列処理

```typescript
// 2つのクエリを同時実行
const [users, totalCount] = await Promise.all([
  prisma.user.findMany({...}),
  prisma.user.count(),
]);
```

#### 効率的なページネーション

```typescript
// skip/take による効率的な実装
skip: (page - 1) * limit,
take: limit,
orderBy: { createdAt: "desc" },
```

---

## 今後の課題・改善点

### 🔄 短期的な改善

1. **バリデーション強化**: Zod 等を使用した入力値検証
2. **ログ管理**: Winston 等を使用した構造化ログ
3. **テスト実装**: Jest 等を使用した単体・統合テスト

### 🚀 中長期的な拡張

1. **監視・メトリクス**: ヘルスチェックの充実
2. **セキュリティ強化**: レート制限、CORS 設定の最適化
3. **キャッシュ**: Redis 等を使用したパフォーマンス向上

---

## 実装完了のマイルストーン 🎉

### ✅ 達成済み

- [x] **プロジェクト基盤構築** - Docker, PostgreSQL, Prisma
- [x] **データベース設計** - 完全な ER 図、マイグレーション
- [x] **型定義システム** - 包括的な型安全性
- [x] **User Controller** - 5 つのエンドポイント完全実装
- [x] **ベストプラクティス適用** - セキュリティ、パフォーマンス、型安全性

### 🔄 次のフェーズ

これで **User 管理機能** の**コントローラー層と型定義**が完全に完成しました。

次のステップは：

1. **ルート層の実装** - Express Router の設定
2. **API 統合テスト** - 実際の動作確認
3. **Post 管理機能** - 次の主要機能の実装

SNS プラットフォームの核となる User 管理システムの実装が、最新のベストプラクティスに従って完成しました！ 🚀
