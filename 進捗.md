# SNS ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é–‹ç™ºã¾ã¨ã‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

TypeScript + Next.js + Express + PostgreSQL + Docker ã§æ§‹ç¯‰ã™ã‚‹ SNS ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: Next.js 14 + TypeScript + Tailwind CSS
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: Express + TypeScript + Prisma ORM
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: PostgreSQL 15
- **ã‚³ãƒ³ãƒ†ãƒŠ**: Docker + Docker Compose
- **é–‹ç™ºç’°å¢ƒ**: Linux (Ubuntu)

---

## ç¾åœ¨ã®é€²æ—çŠ¶æ³

### âœ… å®Œäº†æ¸ˆã¿é …ç›®

#### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```
sns-platform/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ frontend/                   # Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ src/app/
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ next.config.js
â”œâ”€â”€ backend/                    # Express APIã‚µãƒ¼ãƒãƒ¼
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â””â”€â”€ prisma.ts      âœ… å®Œæˆ
â”‚   â”‚   â”œâ”€â”€ controllers/       âœ… userController.ts å®Ÿè£…æ¸ˆã¿
â”‚   â”‚   â”œâ”€â”€ routes/            # ä½œæˆæ¸ˆã¿ï¼ˆç©ºï¼‰
â”‚   â”‚   â”œâ”€â”€ types/             # ä½œæˆæ¸ˆã¿ï¼ˆç©ºï¼‰
â”‚   â”‚   â””â”€â”€ server.ts          âœ… å®Œæˆ
â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”œâ”€â”€ schema.prisma      âœ… å®Œæˆ
â”‚   â”‚   â”œâ”€â”€ migrations/        âœ… å®Œæˆ
â”‚   â”‚   â””â”€â”€ seed.js           âœ… å®Œæˆ
â”‚   â””â”€â”€ package.json
```

#### 2. Docker ç’°å¢ƒ

- PostgreSQL ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ¸ˆã¿
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ `snsplatform` ä½œæˆæ¸ˆã¿
- ãƒ¦ãƒ¼ã‚¶ãƒ¼: `snsuser` / ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: `snspassword`

#### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆPrisma ã‚¹ã‚­ãƒ¼ãƒï¼‰

- User, Post, Follow, Like, Comment, PostImage ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆå®Œäº†
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ¸ˆã¿
- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥æ¸ˆã¿ï¼ˆAlice, Bob ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ + æŠ•ç¨¿ + ãƒ•ã‚©ãƒ­ãƒ¼ + ã„ã„ã­ï¼‰

#### 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤

- Express ã‚µãƒ¼ãƒãƒ¼è¨­å®šå®Œäº†
- Prisma ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šå®Œäº†
- TypeScript è¨­å®šå®Œäº†
- **userController.ts å®Ÿè£…å®Œäº†**

---

## User API ä»•æ§˜

### åŸºæœ¬æƒ…å ±

- Base URL: `http://localhost:8000/api`
- Content-Type: `application/json`
- èªè¨¼: æœªå®Ÿè£…ï¼ˆå¾Œã§ JWT å®Ÿè£…äºˆå®šï¼‰

### å®Ÿè£…æ¸ˆã¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ

```http
POST /api/users
```

**Request Body:**

```json
{
  "email": "user@example.com",
  "username": "johndoe",
  "displayName": "John Doe",
  "bio": "Hello, I'm John!" // optional
}
```

**Response (201 Created):**

```json
{
  "success": true,
  "data": {
    "id": "clxxx123456789",
    "email": "user@example.com",
    "username": "johndoe",
    "displayName": "John Doe",
    "bio": "Hello, I'm John!",
    "profileImageUrl": null,
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  },
  "message": "User created successfully"
}
```

#### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—

```http
GET /api/users/:id
```

**Response (200 OK):**

```json
{
  "success": true,
  "data": {
    "id": "clxxx123456789",
    "email": "user@example.com",
    "username": "johndoe",
    "displayName": "John Doe",
    "bio": "Hello, I'm John!",
    "profileImageUrl": null,
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z",
    "_count": {
      "posts": 5,
      "followers": 10,
      "following": 8
    }
  }
}
```

#### 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰

```http
GET /api/users?page=1&limit=10
```

**Response (200 OK):**

```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": "clxxx123456789",
        "username": "johndoe",
        "displayName": "John Doe",
        "bio": "Hello, I'm John!",
        "profileImageUrl": null,
        "createdAt": "2024-01-15T10:30:00.000Z",
        "_count": {
          "posts": 5,
          "followers": 10
        }
      }
    ],
    "pagination": {
      "currentPage": 1,
      "totalPages": 5,
      "totalItems": 50,
      "hasNext": true,
      "hasPrev": false
    }
  }
}
```

#### 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°

```http
PUT /api/users/:id
```

**Request Body:**

```json
{
  "displayName": "John Smith", // optional
  "bio": "Updated bio", // optional
  "profileImageUrl": "https://example.com/image.jpg" // optional
}
```

#### 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤

```http
DELETE /api/users/:id
```

**Response (200 OK):**

```json
{
  "success": true,
  "message": "User deleted successfully"
}
```

### ä»Šå¾Œå®Ÿè£…äºˆå®šã® API

#### SNS æ©Ÿèƒ½

- `GET /api/users/search?q=john` - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
- `GET /api/users/:id/followers` - ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ä¸€è¦§
- `GET /api/users/:id/following` - ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§
- `GET /api/users/:id/posts` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ä¸€è¦§
- `GET /api/users/:id/likes` - ã„ã„ã­ã—ãŸæŠ•ç¨¿ä¸€è¦§

---

## ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰å®Ÿè£…çŠ¶æ³

### userController.ts ã®ç‰¹å¾´

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- Prisma ã®é‡è¤‡ã‚¨ãƒ©ãƒ¼ï¼ˆP2002ï¼‰ã‚’é©åˆ‡ã«ã‚­ãƒ£ãƒƒãƒ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼ˆP2025ï¼‰ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- TypeScript ã®`unknown`å‹ã‚’ä½¿ç”¨ã—ãŸå®‰å…¨ãªã‚¨ãƒ©ãƒ¼å‡¦ç†

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

- `Math.min`ã‚’ä½¿ç”¨ã—ãŸ DoS æ”»æ’ƒé˜²æ­¢ï¼ˆlimit ä¸Šé™ 50 ä»¶ï¼‰
- `select`ã‚’ä½¿ç”¨ã—ãŸæ©Ÿå¯†æƒ…å ±ï¼ˆemailï¼‰ã®é™¤å¤–

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

- `Promise.all`ã‚’ä½¿ç”¨ã—ãŸä¸¦åˆ—å‡¦ç†
- å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã‚’å–å¾—ã™ã‚‹`select`ã‚¯ã‚¨ãƒª
- åŠ¹ç‡çš„ãªãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…

#### å®Ÿè£…ä¾‹ï¼ˆgetAllUsersï¼‰

```typescript
export const getAllUsers = async (req: Request, res: Response) => {
  try {
    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å®‰å…¨ãªå‡¦ç†
    const page = parseInt(req.query.page as string) || 1;
    const limit = Math.min(parseInt(req.query.limit as string) || 10, 50);
    const skip = (page - 1) * limit;

    // ä¸¦åˆ—å‡¦ç†ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
    const [users, totalCount] = await Promise.all([
      prisma.user.findMany({
        select: {
          // å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å–å¾—ï¼ˆemailã¯é™¤å¤–ï¼‰
          id: true,
          username: true,
          displayName: true,
          bio: true,
          profileImageUrl: true,
          createdAt: true,
          _count: {
            select: {
              posts: true,
              followers: true,
            },
          },
        },
        skip,
        take: limit,
        orderBy: { createdAt: "desc" },
      }),
      prisma.user.count(),
    ]);

    const totalPages = Math.ceil(totalCount / limit);

    res.status(200).json({
      success: true,
      data: {
        users,
        pagination: {
          currentPage: page,
          totalPages,
          totalItems: totalCount,
          hasNext: page < totalPages,
          hasPrev: page > 1,
        },
      },
    });
  } catch (error) {
    console.error("Get users error:", error);
    res.status(500).json({ error: "Failed to fetch users" });
  }
};
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

### ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«

#### User ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
- id (String, PK, CUID)
- email (String, Unique)
- username (String, Unique)
- displayName (String)
- bio (Text, Optional)
- profileImageUrl (String, Optional)
- createdAt (DateTime)
- updatedAt (DateTime)
```

#### Post ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
- id (String, PK, CUID)
- userId (String, FK -> User.id)
- content (String, 280æ–‡å­—åˆ¶é™)
- createdAt (DateTime)
- updatedAt (DateTime)
- deletedAt (DateTime, Optional)
```

#### Follow ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
- id (String, PK, CUID)
- followerId (String, FK -> User.id)
- followingId (String, FK -> User.id)
- createdAt (DateTime)
- UNIQUE(followerId, followingId)
```

#### Like ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
- id (String, PK, CUID)
- userId (String, FK -> User.id)
- postId (String, FK -> Post.id)
- createdAt (DateTime)
- UNIQUE(userId, postId)
```

---

## æ¬¡ã®å®Ÿè£…äºˆå®š

### ğŸ”„ ç¾åœ¨ã®å„ªå…ˆã‚¿ã‚¹ã‚¯

1. **å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ**

   - `backend/src/types/user.ts`
   - `CreateUserRequest`, `UpdateUserRequest` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©

2. **ãƒ«ãƒ¼ãƒˆå®šç¾©ã®å®Ÿè£…**

   - `backend/src/routes/users.ts`
   - userController ã®å„é–¢æ•°ã‚’ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æ¥ç¶š

3. **ã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒ«ãƒ¼ãƒˆæ¥ç¶š**

   - `backend/src/server.ts`ã®æ›´æ–°
   - `/api/users`ãƒ«ãƒ¼ãƒˆã®è¿½åŠ 

4. **API å‹•ä½œç¢ºèª**
   - Postman ã‚„ curl ã§ã®å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ

### ğŸš€ ä»Šå¾Œã®å®Ÿè£…äºˆå®š

#### Phase 1: åŸºæœ¬ API å®Ÿè£…

- [ ] Post Controller (æŠ•ç¨¿ CRUD)
- [ ] Follow Controller (ãƒ•ã‚©ãƒ­ãƒ¼æ©Ÿèƒ½)
- [ ] Like Controller (ã„ã„ã­æ©Ÿèƒ½)
- [ ] Comment Controller (ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½)

#### Phase 2: èªè¨¼æ©Ÿèƒ½

- [ ] JWT èªè¨¼ã®å®Ÿè£…
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
- [ ] ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢èªè¨¼

#### Phase 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

- [ ] Next.js + TailwindCSS ã§ã® UI å®Ÿè£…
- [ ] API é€£æº
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ï¼ˆWebSocketï¼‰

---

## é–‹ç™ºç’°å¢ƒ

### èµ·å‹•æ–¹æ³•

```bash
# 1. Dockerç’°å¢ƒèµ·å‹•
cd sns-platform
docker-compose up -d

# 2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
cd backend
npm run dev

# 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
cd frontend
npm run dev
```

### å‹•ä½œç¢ºèª URL

- Backend: http://localhost:8000/health
- Frontend: http://localhost:3000
- Prisma Studio: `npx prisma studio` â†’ http://localhost:5555

### ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£
npx prisma studio             # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ã‚¦ã‚¶
npx prisma generate           # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå†ç”Ÿæˆ
npx prisma migrate dev        # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

# APIå‹•ä½œç¢ºèª
curl http://localhost:8000/health
curl http://localhost:8000/api/test

# Dockeræ“ä½œ
docker-compose logs -f db     # DBãƒ­ã‚°ç¢ºèª
docker-compose down           # ç’°å¢ƒåœæ­¢
```

---

## å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆãƒ»ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- DoS æ”»æ’ƒé˜²æ­¢ã®ãŸã‚ã® limit ä¸Šé™è¨­å®š
- æ©Ÿå¯†æƒ…å ±ï¼ˆemail ç­‰ï¼‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹é™¤å¤–
- Prisma ã‚¨ãƒ©ãƒ¼ã®é©åˆ‡ãªãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- `Promise.all`ã«ã‚ˆã‚‹ä¸¦åˆ—å‡¦ç†
- `select`ã«ã‚ˆã‚‹å¿…è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã®å–å¾—
- åŠ¹ç‡çš„ãªãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…

### TypeScript

- `unknown`å‹ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- é©åˆ‡ãªå‹å®šç¾©ã®ä½¿ç”¨
- ES Module ã®æ­£ã—ã„ä½¿ç”¨

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

- å¤–éƒ¨ã‚­ãƒ¼ã®æ­£ã—ã„è¨­è¨ˆ
- ä¸€æ„åˆ¶ç´„ã«ã‚ˆã‚‹é‡è¤‡é˜²æ­¢
- ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆï¼ˆdeletedAtï¼‰ã®å®Ÿè£…

---

## ä»Šå¾Œã®èª²é¡Œãƒ»æ”¹å–„ç‚¹

1. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–**: Zod ç­‰ã‚’ä½¿ç”¨ã—ãŸå…¥åŠ›å€¤æ¤œè¨¼
2. **ãƒ­ã‚°ç®¡ç†**: Winston ç­‰ã‚’ä½¿ç”¨ã—ãŸæ§‹é€ åŒ–ãƒ­ã‚°
3. **ãƒ†ã‚¹ãƒˆå®Ÿè£…**: Jest ç­‰ã‚’ä½¿ç”¨ã—ãŸå˜ä½“ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ
4. **ç›£è¦–ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹**: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®å……å®Ÿ
5. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€CORS è¨­å®šã®æœ€é©åŒ–

---

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€SNS ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®åŸºç›¤ã¨ãªã‚‹ User ç®¡ç†æ©Ÿèƒ½ãŒå®Œæˆã—ã¾ã—ãŸã€‚æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€å‹å®šç¾©ã¨ãƒ«ãƒ¼ãƒˆå®Ÿè£…ã‚’é€²ã‚ã¦ã„ãäºˆå®šã§ã™ã€‚
